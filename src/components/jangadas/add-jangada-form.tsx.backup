"use client";

import { useState, useEffect, useMemo } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { MonthYearPicker } from '@/components/ui/month-year-picker'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import {
  Ship,
  Save,
  CheckCircle,
  AlertCircle,
  Info
} from 'lucide-react'
import { useCreateJangada } from '@/hooks/use-jangadas'
import { useNavios } from '@/hooks/use-navios'
import { jangadaSchema, type JangadaForm } from '@/lib/validation-schemas'
import { Navio } from '@/lib/types'
import { MARCAS_JANGADA, MODELOS_JANGADA, TIPOS_PACK, COMPONENTES_POR_PACK, ESPECIFICACOES_POR_MARCA_MODELO } from '@/lib/jangada-options'
import { cn } from '@/lib/utils'

interface AddJangadaFormProps {
  onSuccess?: () => void
}

export function AddJangadaForm({ onSuccess }: AddJangadaFormProps) {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [selectedMarca, setSelectedMarca] = useState<string>('')
  const [selectedModelo, setSelectedModelo] = useState<string>('')
  const [selectedCapacidade, setSelectedCapacidade] = useState<number | null>(null)
  const [selectedPack, setSelectedPack] = useState<string>('')
  const router = useRouter()
  const createJangadaMutation = useCreateJangada()
  const { data: naviosResponse } = useNavios()
  const navios = naviosResponse?.data || []

  // Form setup with simplified schema
  const form = useForm<JangadaForm>({
    resolver: zodResolver(jangadaSchema),
    defaultValues: {
      numeroSerie: '',
      marca: '',
      modelo: '',
      tipo: '',
      tipoPack: '',
      componentesSelecionados: {},
      validadeComponentes: {},
      dataFabricacao: undefined,
      dataInspecao: undefined,
      dataProximaInspecao: undefined,
      status: 'ativo',
      clienteId: undefined,
      navioId: undefined,
      proprietarioId: undefined,
      tecnicoResponsavel: '',
      // Cylinder fields
      cilindroNumeroSerie: '',
      cilindroTipo: '',
      cilindroSistema: '',
      cilindroCapacidade: undefined,
      cilindroTara: undefined,
      cilindroPesoBruto: undefined,
      cilindroQuantidadeCO2: undefined,
      cilindroQuantidadeN2: undefined,
      cilindroTesteHidraulico: undefined,
      cilindroProximoTesteHidraulico: undefined,
      cilindroValidade: '',
      // Additional fields
      lotacao: undefined,
      hru: '',
      tubosAltaPressao: undefined,
      validadeTubosAltaPressao: '',
      tubosAltaPressaoSuperior: undefined,
      validadeTubosAltaPressaoSuperior: '',
      tubosAltaPressaoInferior: undefined,
      validadeTubosAltaPressaoInferior: '',
      valvulasAlivio: undefined,
      validadeValvulasAlivio: '',
      cabecasDisparo: undefined,
      validadeCabecasDisparo: '',
      valvulasInsuflacao: undefined,
      bateriaLitio: undefined,
      luzExterior: undefined,
    },
  })

  // Get available models for selected brand
  const modelosDisponiveis = useMemo(() => {
    if (!selectedMarca) return []
    return Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
      .filter(key => ESPECIFICACOES_POR_MARCA_MODELO[key].marca === selectedMarca)
      .map(key => ESPECIFICACOES_POR_MARCA_MODELO[key].modelo)
  }, [selectedMarca])

  // Get available capacities for selected brand and model
  const capacidadesDisponiveis = useMemo(() => {
    if (!selectedMarca || !selectedModelo) return []
    const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
      .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)
    return key ? ESPECIFICACOES_POR_MARCA_MODELO[key].capacidades.map(cap => cap.pessoas) : []
  }, [selectedMarca, selectedModelo])

  // Get available packs for selected brand and model
  const packsDisponiveis = useMemo(() => {
    if (!selectedMarca || !selectedModelo) return []
    const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
      .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)
    return key ? ESPECIFICACOES_POR_MARCA_MODELO[key].packs : []
  }, [selectedMarca, selectedModelo])

  // Auto-fill quantities when brand, model, capacity, and pack are selected
  useEffect(() => {
    if (selectedMarca && selectedModelo && selectedCapacidade && selectedPack) {
      const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
        .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                  ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)

      if (key) {
        const spec = ESPECIFICACOES_POR_MARCA_MODELO[key]
        const capacidadeInfo = spec.capacidades.find(cap => cap.pessoas === selectedCapacidade)

        if (capacidadeInfo && COMPONENTES_POR_PACK[selectedPack]) {
          // Auto-fill components with quantities from pack
          const componentesAuto = COMPONENTES_POR_PACK[selectedPack].reduce((acc, comp) => {
            acc[comp.nome] = { incluido: true, quantidade: 1 }
            return acc
          }, {} as Record<string, { incluido: boolean; quantidade: number }>)

          // Set cylinder information
          form.setValue('cilindroTipo', 'CO2/N2')
          form.setValue('cilindroSistema', spec.sistemaInsuflacao)
          form.setValue('cilindroCapacidade', selectedCapacidade)

          // Parse CO2 quantity
          const co2Match = capacidadeInfo.cilindroCO2.match(/(\d+(?:\.\d+)?)kg CO2/)
          if (co2Match) {
            form.setValue('cilindroQuantidadeCO2', parseFloat(co2Match[1]))
          }

          // Parse N2 quantity
          const n2Match = capacidadeInfo.cilindroCO2.match(/(\d+(?:\.\d+)?)kg N2/)
          if (n2Match) {
            form.setValue('cilindroQuantidadeN2', parseFloat(n2Match[1]))
          }

          // Set type based on capacity
          form.setValue('tipo', `${selectedCapacidade} pessoas`)

          // Set components
          form.setValue('componentesSelecionados', componentesAuto)

          // Set lotacao (capacity)
          form.setValue('lotacao', selectedCapacidade)

          // Set default validity dates for components (5 years from now)
          const fiveYearsFromNow = new Date()
          fiveYearsFromNow.setFullYear(fiveYearsFromNow.getFullYear() + 5)

          const validadeComponentes = COMPONENTES_POR_PACK[selectedPack].reduce((acc, comp) => {
            if (comp.validade) {
              acc[comp.nome] = fiveYearsFromNow.toISOString().split('T')[0]
            }
            return acc
          }, {} as Record<string, string>)

          form.setValue('validadeComponentes', validadeComponentes)
        }
      }
    }
  }, [selectedMarca, selectedModelo, selectedCapacidade, selectedPack, form])

  const handleMarcaChange = (marca: string) => {
    setSelectedMarca(marca)
    setSelectedModelo('')
    setSelectedCapacidade(null)
    setSelectedPack('')
    form.setValue('marca', marca)
    form.setValue('modelo', '')
    form.setValue('tipo', '')
    form.setValue('tipoPack', '')
  }

  const handleModeloChange = (modelo: string) => {
    setSelectedModelo(modelo)
    setSelectedCapacidade(null)
    setSelectedPack('')
    form.setValue('modelo', modelo)
    form.setValue('tipo', '')
    form.setValue('tipoPack', '')
  }

  const handleCapacidadeChange = (capacidade: string) => {
    const cap = parseInt(capacidade)
    setSelectedCapacidade(cap)
    setSelectedPack('')
    form.setValue('tipoPack', '')
  }

  const handlePackChange = (pack: string) => {
    setSelectedPack(pack)
    form.setValue('tipoPack', pack)
  }

  const onSubmit = async (data: JangadaForm) => {
    try {
      setIsSubmitting(true)
      await createJangadaMutation.mutateAsync(data)
      if (onSuccess) {
        onSuccess()
      } else {
        router.push('/jangadas')
      }
    } catch (error) {
      console.error('Erro ao criar jangada:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <Card className="border-0 shadow-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20">
        <CardHeader className="text-center">
          <div className="flex items-center justify-center mb-4">
            <div className="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
              <Ship className="w-8 h-8 text-blue-600 dark:text-blue-400" />
            </div>
          </div>
          <CardTitle className="text-2xl font-bold text-gray-900 dark:text-white">
            Adicionar Jangada Salva-Vidas
          </CardTitle>
          <CardDescription className="text-lg">
            Preencha apenas as informações básicas. As quantidades serão preenchidas automaticamente.
          </CardDescription>
        </CardHeader>
      </Card>

      {/* Info Alert */}
      <Alert className="border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/20">
        <Info className="h-4 w-4 text-blue-600" />
        <AlertDescription className="text-blue-800 dark:text-blue-200">
          <strong>Formulário Simplificado:</strong> Apenas campos essenciais são obrigatórios.
          As quantidades de componentes e especificações técnicas são preenchidas automaticamente
          com base na marca, modelo, capacidade e tipo de pack selecionados.
        </AlertDescription>
      </Alert>

      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
          <Card className="border-0 shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Ship className="w-5 h-5" />
                Informações Básicas da Jangada
              </CardTitle>
              <CardDescription>
                Selecione a marca, modelo, capacidade e tipo de pack
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Brand */}
                <FormField
                  control={form.control}
                  name="marca"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Marca *</FormLabel>
                      <Select onValueChange={handleMarcaChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger className="h-12">
                            <SelectValue placeholder="Selecione a marca" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {MARCAS_JANGADA.map((marca) => (
                            <SelectItem key={marca} value={marca}>
                              {marca}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Model */}
                <FormField
                  control={form.control}
                  name="modelo"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Modelo *</FormLabel>
                      <Select
                        onValueChange={handleModeloChange}
                        value={field.value}
                        disabled={!selectedMarca}
                      >
                        <FormControl>
                          <SelectTrigger className="h-12">
                            <SelectValue placeholder={selectedMarca ? "Selecione o modelo" : "Selecione a marca primeiro"} />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {modelosDisponiveis.map((modelo) => (
                            <SelectItem key={modelo} value={modelo}>
                              {modelo}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Capacity */}
                <FormField
                  control={form.control}
                  name="tipo"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Capacidade (pessoas) *</FormLabel>
                      <Select
                        onValueChange={handleCapacidadeChange}
                        value={selectedCapacidade?.toString() || ""}
                        disabled={!selectedModelo}
                      >
                        <FormControl>
                          <SelectTrigger className="h-12">
                            <SelectValue placeholder={selectedModelo ? "Selecione a capacidade" : "Selecione o modelo primeiro"} />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {capacidadesDisponiveis.map((capacidade) => (
                            <SelectItem key={capacidade} value={capacidade.toString()}>
                              {capacidade} pessoas
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Pack Type */}
                <FormField
                  control={form.control}
                  name="tipoPack"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Tipo de Pack *</FormLabel>
                      <Select
                        onValueChange={handlePackChange}
                        value={field.value}
                        disabled={!selectedCapacidade}
                      >
                        <FormControl>
                          <SelectTrigger className="h-12">
                            <SelectValue placeholder={selectedCapacidade ? "Selecione o tipo de pack" : "Selecione a capacidade primeiro"} />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {packsDisponiveis.map((pack) => (
                            <SelectItem key={pack} value={pack}>
                              {pack}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Serial Number */}
                <FormField
                  control={form.control}
                  name="numeroSerie"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Número de Série *</FormLabel>
                      <FormControl>
                        <Input
                          placeholder="Digite o número de série"
                          className="h-12"
                          {...field}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                {/* Manufacture Date */}
                <FormField
                  control={form.control}
                  name="dataFabricacao"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="text-base font-semibold">Data de Fabricação *</FormLabel>
                      <FormControl>
                        <MonthYearPicker
                          value={field.value}
                          onChange={field.onChange}
                          placeholder="Selecione mês e ano"
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              {/* Auto-filled Information Display */}
              {selectedMarca && selectedModelo && selectedCapacidade && selectedPack && (
                <div className="mt-8 p-6 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800">
                  <div className="flex items-center gap-2 mb-4">
                    <CheckCircle className="w-5 h-5 text-green-600" />
                    <h3 className="text-lg font-semibold text-green-800 dark:text-green-200">
                      Informações Preenchidas Automaticamente
                    </h3>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium text-green-700 dark:text-green-300">Sistema de Insuflação:</span>
                      <span className="ml-2 text-green-600 dark:text-green-400">
                        {(() => {
                          const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
                            .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                                      ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)
                          return key ? ESPECIFICACOES_POR_MARCA_MODELO[key].sistemaInsuflacao : 'N/A'
                        })()}
                      </span>
                    </div>

                    <div>
                      <span className="font-medium text-green-700 dark:text-green-300">Válvulas:</span>
                      <span className="ml-2 text-green-600 dark:text-green-400">
                        {(() => {
                          const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
                            .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                                      ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)
                          return key ? ESPECIFICACOES_POR_MARCA_MODELO[key].valvulas.join(', ') : 'N/A'
                        })()}
                      </span>
                    </div>

                    <div>
                      <span className="font-medium text-green-700 dark:text-green-300">Cilindro CO2:</span>
                      <span className="ml-2 text-green-600 dark:text-green-400">
                        {(() => {
                          const key = Object.keys(ESPECIFICACOES_POR_MARCA_MODELO)
                            .find(k => ESPECIFICACOES_POR_MARCA_MODELO[k].marca === selectedMarca &&
                                      ESPECIFICACOES_POR_MARCA_MODELO[k].modelo === selectedModelo)
                          const capacidadeInfo = key ? ESPECIFICACOES_POR_MARCA_MODELO[key].capacidades
                            .find(cap => cap.pessoas === selectedCapacidade) : null
                          return capacidadeInfo ? capacidadeInfo.cilindroCO2 : 'N/A'
                        })()}
                      </span>
                    </div>

                    <div>
                      <span className="font-medium text-green-700 dark:text-green-300">Componentes do Pack:</span>
                      <span className="ml-2 text-green-600 dark:text-green-400">
                        {COMPONENTES_POR_PACK[selectedPack]?.length || 0} itens incluídos
                      </span>
                    </div>
                  </div>
                </div>
              )}

              <Separator />

              {/* Optional Fields */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                  Informações Adicionais (Opcional)
                </h3>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Ship */}
                  <FormField
                    control={form.control}
                    name="navioId"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Navio (Opcional)</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value || ""}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selecione o navio" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            {navios.map((navio) => (
                              <SelectItem key={navio.id} value={navio.id}>
                                {navio.nome}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {/* Technician */}
                  <FormField
                    control={form.control}
                    name="tecnicoResponsavel"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Técnico Responsável (Opcional)</FormLabel>
                        <FormControl>
                          <Input
                            placeholder="Nome do técnico"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Submit Button */}
          <Card className="border-0 shadow-sm">
            <CardContent className="pt-6">
              <div className="flex justify-end">
                <Button
                  type="submit"
                  disabled={isSubmitting || !form.formState.isValid}
                  className="flex items-center gap-2 bg-green-600 hover:bg-green-700 h-12 px-8"
                >
                  {isSubmitting ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                      Criando Jangada...
                    </>
                  ) : (
                    <>
                      <Save className="h-4 w-4" />
                      Criar Jangada
                    </>
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        </form>
      </Form>
    </div>
  )
},
    {
      name: 'marca',
      value: watchedMarca,
      rules: [
        { type: 'required' as const, message: 'Marca é obrigatória' }
      ]
    },
    {
      name: 'modelo',
      value: watchedModelo,
      rules: [
        { type: 'required' as const, message: 'Modelo é obrigatório' }
      ]
    },
    {
      name: 'tipo',
      value: watchedTipo,
      rules: [
        { type: 'required' as const, message: 'Tipo é obrigatório' }
      ]
    },
    {
      name: 'navioId',
      value: watchedNavioId,
      rules: [
        { type: 'required' as const, message: 'Navio é obrigatório' }
      ]
    }
  ], [watchedNumeroSerie, watchedMarca, watchedModelo, watchedTipo, watchedNavioId]);

  // Ensure validation results exist
  const safeValidationResults = {};

  // Ensure component is mounted before rendering
  useEffect(() => {
    setIsMounted(true);
  }, []);

  // Don't render until mounted to prevent prerendering issues
  if (!isMounted) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="text-muted-foreground">Carregando...</div>
      </div>
    );
  }

  const onSubmit = async (data: JangadaForm) => {
    if (currentStep !== 'review') {
      nextStep()
      return
    }

    setIsSubmitting(true)
    try {
      await createJangadaMutation.mutateAsync(data)
      if (onSuccess) {
        onSuccess()
      } else {
        router.push('/jangadas')
      }
    } catch (error) {
      console.error('Erro ao criar jangada:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (!isMounted) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="text-muted-foreground">Carregando...</div>
      </div>
    );
  }

  return (
    <div className="w-full max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <Card className="border-0 shadow-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-2xl font-bold flex items-center gap-3">
                <div className="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                  <Ship className="h-6 w-6 text-blue-600 dark:text-blue-400" />
                </div>
                Nova Jangada
              </CardTitle>
              <CardDescription className="text-base mt-1">
                Configure uma nova jangada de salvamento com todos os componentes necessários
              </CardDescription>
            </div>
            {selectedMarca && selectedModelo && (
              <Badge variant="secondary" className="px-3 py-1">
                <Sparkles className="h-4 w-4 mr-2" />
                Template: {selectedMarca} {selectedModelo}
              </Badge>
            )}
          </div>
        </CardHeader>
      </Card>

      {/* Progress Steps */}
      <Card className="border-0 shadow-sm">
        <CardContent className="pt-6">
          <div className="space-y-4">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium">Progresso da Configuração</span>
              <span className="text-muted-foreground">{currentStepIndex + 1} de {steps.length}</span>
            </div>
            <Progress value={progress} className="h-2" />
            <div className="flex justify-between">
              {steps.map((step, index) => (
                <button
                  key={step.id}
                  onClick={() => goToStep(step.id)}
                  className={cn(
                    "flex flex-col items-center p-3 rounded-lg transition-all duration-200",
                    currentStepIndex >= index
                      ? "bg-blue-50 dark:bg-blue-950/20 text-blue-700 dark:text-blue-300"
                      : "text-muted-foreground hover:text-foreground",
                    currentStep === step.id && "ring-2 ring-blue-500 bg-blue-100 dark:bg-blue-900/30"
                  )}
                >
                  <div className={cn(
                    "p-2 rounded-full mb-2 transition-colors",
                    currentStepIndex >= index
                      ? "bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400"
                      : "bg-muted"
                  )}>
                    {step.icon}
                  </div>
                  <span className="font-medium text-xs text-center">{step.title}</span>
                  <span className="text-xs text-center opacity-75 mt-1">{step.description}</span>
                </button>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Form Content */}
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
          {/* Step Content */}
          <Card className="border-0 shadow-lg">
            <CardContent className="p-6">
              {currentStep === 'basic' && <BasicInfoStep form={form} navios={navios} />}
              {currentStep === 'components' && (
                <ComponentsStep
                  form={form}
                  selectedComponents={selectedComponents}
                  onAddComponent={addComponent}
                  onRemoveComponent={removeComponent}
                  onUpdateQuantity={updateComponentQuantity}
                  onUpdateValidity={updateComponentValidity}
                  stockItems={stockItems}
                />
              )}
              {currentStep === 'cylinder' && <CylinderStep form={form} />}
              {currentStep === 'review' && <ReviewStep form={form} selectedComponents={selectedComponents} />}
            </CardContent>
          </Card>

          {/* Navigation Buttons */}
          <Card className="border-0 shadow-sm">
            <CardContent className="pt-6">
              <div className="flex justify-between">
                <Button
                  type="button"
                  variant="outline"
                  onClick={prevStep}
                  disabled={currentStepIndex === 0}
                  className="flex items-center gap-2"
                >
                  <ArrowLeft className="h-4 w-4" />
                  Anterior
                </Button>

                <div className="flex gap-3">
                  {currentStep !== 'review' ? (
                    <Button
                      type="submit"
                      className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700"
                    >
                      Próximo
                      <ArrowRight className="h-4 w-4" />
                    </Button>
                  ) : (
                    <Button
                      type="submit"
                      disabled={isSubmitting || !form.formState.isValid}
                      className="flex items-center gap-2 bg-green-600 hover:bg-green-700"
                    >
                      {isSubmitting ? (
                        <>
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                          Criando...
                        </>
                      ) : (
                        <>
                          <Save className="h-4 w-4" />
                          Criar Jangada
                        </>
                      )}
                    </Button>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        </form>
      </Form>
    </div>
  )
}

// Step Components
function BasicInfoStep({ form, navios }: { form: any, navios: Navio[] }) {
  return (
    <div className="space-y-6">
      <div className="text-center mb-6">
        <h3 className="text-lg font-semibold mb-2">Informações Básicas</h3>
        <p className="text-muted-foreground">Configure as informações principais da jangada</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <FormField
          control={form.control}
          name="numeroSerie"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="flex items-center gap-2">
                <CheckCircle className="h-4 w-4 text-blue-500" />
                Número de Série *
              </FormLabel>
              <FormControl>
                <Input
                  placeholder="Digite o número de série único"
                  className="text-lg"
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="tipo"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Tipo de Jangada *</FormLabel>
              <Select onValueChange={field.onChange} value={field.value}>
                <FormControl>
                  <SelectTrigger className="text-lg">
                    <SelectValue placeholder="Selecione o tipo" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="6pessoas">6 Pessoas</SelectItem>
                  <SelectItem value="8pessoas">8 Pessoas</SelectItem>
                  <SelectItem value="10pessoas">10 Pessoas</SelectItem>
                  <SelectItem value="12pessoas">12 Pessoas</SelectItem>
                  <SelectItem value="15pessoas">15 Pessoas</SelectItem>
                  <SelectItem value="20pessoas">20 Pessoas</SelectItem>
                  <SelectItem value="25pessoas">25 Pessoas</SelectItem>
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      <Separator />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <FormField
          control={form.control}
          name="navioId"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="flex items-center gap-2">
                <Ship className="h-4 w-4 text-blue-500" />
                Navio Associado
              </FormLabel>
              <Select onValueChange={(value) => field.onChange(value === "none" ? undefined : value)} value={field.value || "none"}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o navio" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="none">Nenhum</SelectItem>
                  {navios.map((navio) => (
                    <SelectItem key={navio.id} value={navio.id}>
                      {navio.nome} ({navio.matricula})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="status"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Status *</FormLabel>
              <Select onValueChange={field.onChange} value={field.value}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o status" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="ativo">Ativo</SelectItem>
                  <SelectItem value="manutencao">Manutenção</SelectItem>
                  <SelectItem value="inativo">Inativo</SelectItem>
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      <Separator />

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <FormField
          control={form.control}
          name="dataFabricacao"
          render={({ field }) => (
            <FormItem className="flex flex-col">
              <FormLabel>Data de Fabricação</FormLabel>
              <FormControl>
                <DatePicker
                  date={field.value}
                  onDateChange={field.onChange}
                  placeholder="Selecione a data"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="dataInspecao"
          render={({ field }) => (
            <FormItem className="flex flex-col">
              <FormLabel>Data da Inspeção</FormLabel>
              <FormControl>
                <DatePicker
                  date={field.value}
                  onDateChange={field.onChange}
                  placeholder="Selecione a data"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="dataProximaInspecao"
          render={({ field }) => (
            <FormItem className="flex flex-col">
              <FormLabel>Próxima Inspeção</FormLabel>
              <FormControl>
                <DatePicker
                  date={field.value}
                  onDateChange={field.onChange}
                  placeholder="Selecione a data"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>
    </div>
  )
}

function ComponentsStep({
  form,
  selectedComponents,
  onAddComponent,
  onRemoveComponent,
  onUpdateQuantity,
  onUpdateValidity,
  stockItems
}: {
  form: any,
  selectedComponents: string[],
  onAddComponent: (component: string) => void,
  onRemoveComponent: (component: string) => void,
  onUpdateQuantity: (component: string, quantity: number) => void,
  onUpdateValidity: (component: string, validity: string) => void,
  stockItems: any[]
}) {
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedPack, setSelectedPack] = useState<string>('')

  const availableComponents = [
    'Rações de Emergência',
    'Água Potável',
    'Kit de Primeiros Socorros',
    'Foguetes com Paraquedas',
    'Lanterna Estanque',
    'Apito',
    'Faca de Ponta Redonda Flutuante',
    'Esponjas',
    'Manta Térmica',
    'Kit de Reparação',
    'Âncora Flutuante (Drogue)',
    'Bateria de Reserva',
    'Rádio VHF',
    'GPS',
    'Bússola',
    'Mapa Náutico'
  ]

  const filteredComponents = availableComponents.filter(comp =>
    comp.toLowerCase().includes(searchTerm.toLowerCase()) &&
    !selectedComponents.includes(comp)
  )

  return (
    <div className="space-y-6">
      <div className="text-center mb-6">
        <h3 className="text-lg font-semibold mb-2">Configuração de Componentes</h3>
        <p className="text-muted-foreground">Selecione os componentes e configure o pack da jangada</p>
      </div>

      {/* Pack Selection */}
      <Card className="border-dashed">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Package className="h-5 w-5" />
            Tipo de Pack
          </CardTitle>
        </CardHeader>
        <CardContent>
          <FormField
            control={form.control}
            name="tipoPack"
            render={({ field }) => (
              <FormItem>
                <Select onValueChange={field.onChange} value={field.value}>
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione o tipo de pack" />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="basico">Pack Básico</SelectItem>
                    <SelectItem value="completo">Pack Completo</SelectItem>
                    <SelectItem value="premium">Pack Premium</SelectItem>
                    <SelectItem value="personalizado">Pack Personalizado</SelectItem>
                  </SelectContent>
                </Select>
                <FormMessage />
              </FormItem>
            )}
          />
        </CardContent>
      </Card>

      {/* Component Search and Selection */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Available Components */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Plus className="h-5 w-5" />
              Componentes Disponíveis
            </CardTitle>
            <div className="relative">
              <Input
                placeholder="Buscar componentes..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-8"
              />
              <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {filteredComponents.map((component) => (
                <div
                  key={component}
                  className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
                >
                  <span className="text-sm">{component}</span>
                  <Button
                    type="button"
                    size="sm"
                    onClick={() => onAddComponent(component)}
                    className="h-8 w-8 p-0"
                  >
                    <Plus className="h-4 w-4" />
                  </Button>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Selected Components */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <CheckCircle className="h-5 w-5" />
              Componentes Selecionados ({selectedComponents.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {selectedComponents.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                <Package className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Nenhum componente selecionado</p>
                <p className="text-sm">Adicione componentes da lista ao lado</p>
              </div>
            ) : (
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {selectedComponents.map((component) => {
                  const componentData = form.watch(`componentesSelecionados.${component}`)
                  return (
                    <Card key={component} className="border-l-4 border-l-blue-500">
                      <CardContent className="p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="font-medium">{component}</h4>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => onRemoveComponent(component)}
                            className="h-8 w-8 p-0 text-red-500 hover:text-red-700"
                          >
                            <Minus className="h-4 w-4" />
                          </Button>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="text-xs font-medium text-muted-foreground">Quantidade</label>
                            <Input
                              type="number"
                              min="1"
                              value={componentData?.quantidade || 1}
                              onChange={(e) => onUpdateQuantity(component, parseInt(e.target.value) || 1)}
                              className="h-8 text-sm"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-medium text-muted-foreground">Validade</label>
                            <Input
                              placeholder="MM/AAAA"
                              value={form.watch(`validadeComponentes.${component}`) || ''}
                              onChange={(e) => onUpdateValidity(component, e.target.value)}
                              className="h-8 text-sm"
                            />
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  )
}

function CylinderStep({ form }: { form: any }) {
  return (
    <div className="space-y-6">
      <div className="text-center mb-6">
        <h3 className="text-lg font-semibold mb-2">Configuração do Cilindro</h3>
        <p className="text-muted-foreground">Configure os parâmetros do cilindro de gás</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <FormField
          control={form.control}
          name="cilindroNumeroSerie"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Número de Série do Cilindro</FormLabel>
              <FormControl>
                <Input placeholder="Digite o número de série" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="cilindroTipo"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Tipo de Cilindro</FormLabel>
              <Select onValueChange={field.onChange} value={field.value}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Selecione o tipo" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="co2">CO2</SelectItem>
                  <SelectItem value="n2">N2</SelectItem>
                  <SelectItem value="mistura">Mistura</SelectItem>
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <FormField
          control={form.control}
          name="cilindroCapacidade"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Capacidade (kg)</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  step="0.1"
                  placeholder="0.0"
                  value={field.value || ''}
                  onChange={(e) => field.onChange(e.target.value ? parseFloat(e.target.value) : undefined)}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="cilindroTara"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Peso Vazio (kg)</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  step="0.1"
                  placeholder="0.0"
                  value={field.value || ''}
                  onChange={(e) => field.onChange(e.target.value ? parseFloat(e.target.value) : undefined)}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="cilindroPesoBruto"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Peso Cheio (kg)</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  step="0.1"
                  placeholder="0.0"
                  value={field.value || ''}
                  onChange={(e) => field.onChange(e.target.value ? parseFloat(e.target.value) : undefined)}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      <Separator />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <FormField
          control={form.control}
          name="cilindroTesteHidraulico"
          render={({ field }) => (
            <FormItem className="flex flex-col">
              <FormLabel>Último Teste Hidráulico</FormLabel>
              <FormControl>
                <DatePicker
                  date={field.value}
                  onDateChange={field.onChange}
                  placeholder="Selecione a data"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="cilindroValidade"
          render={({ field }) => (
            <FormItem className="flex flex-col">
              <FormLabel>Validade do Cilindro</FormLabel>
              <FormControl>
                <MonthYearPicker
                  value={field.value}
                  onValueChange={field.onChange}
                  placeholder="MM/AAAA"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>
    </div>
  )
}

function ReviewStep({ form, selectedComponents }: { form: any, selectedComponents: string[] }) {
  const formData = form.watch()

  return (
    <div className="space-y-6">
      <div className="text-center mb-6">
        <h3 className="text-lg font-semibold mb-2">Revisão Final</h3>
        <p className="text-muted-foreground">Confirme todas as configurações antes de criar a jangada</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Basic Information */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Ship className="h-5 w-5" />
              Informações Básicas
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Número de Série:</span>
              <span className="font-medium">{formData.numeroSerie || 'Não definido'}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Tipo:</span>
              <span className="font-medium">{formData.tipo || 'Não definido'}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Status:</span>
              <Badge variant={formData.status === 'ativo' ? 'default' : 'secondary'}>
                {formData.status === 'ativo' ? 'Ativo' : formData.status === 'manutencao' ? 'Manutenção' : 'Inativo'}
              </Badge>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Data de Fabricação:</span>
              <span className="font-medium">
                {formData.dataFabricacao ? new Date(formData.dataFabricacao).toLocaleDateString() : 'Não definida'}
              </span>
            </div>
          </CardContent>
        </Card>

        {/* Components */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Package className="h-5 w-5" />
              Componentes ({selectedComponents.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            {selectedComponents.length === 0 ? (
              <p className="text-muted-foreground">Nenhum componente selecionado</p>
            ) : (
              <div className="space-y-2">
                {selectedComponents.map((component) => {
                  const componentData = formData.componentesSelecionados?.[component]
                  return (
                    <div key={component} className="flex justify-between items-center text-sm">
                      <span>{component}</span>
                      <div className="flex gap-2">
                        <Badge variant="outline">Qtd: {componentData?.quantidade || 1}</Badge>
                        {formData.validadeComponentes?.[component] && (
                          <Badge variant="outline">Val: {formData.validadeComponentes[component]}</Badge>
                        )}
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Cylinder Information */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Settings className="h-5 w-5" />
              Cilindro
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Número de Série:</span>
              <span className="font-medium">{formData.cilindroNumeroSerie || 'Não definido'}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Tipo:</span>
              <span className="font-medium">{formData.cilindroTipo || 'Não definido'}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Capacidade:</span>
              <span className="font-medium">{formData.cilindroCapacidade ? `${formData.cilindroCapacidade} kg` : 'Não definida'}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Validade:</span>
              <span className="font-medium">{formData.cilindroValidade || 'Não definida'}</span>
            </div>
          </CardContent>
        </Card>

        {/* Summary */}
        <Card className="border-green-200 bg-green-50/50 dark:bg-green-950/20">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-green-700 dark:text-green-400">
              <CheckCircle className="h-5 w-5" />
              Resumo da Configuração
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Componentes:</span>
              <span className="font-medium text-green-700">{selectedComponents.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Campos obrigatórios:</span>
              <span className="font-medium text-green-700">
                {formData.numeroSerie && formData.tipo && formData.status ? '✓ Completos' : '✗ Incompletos'}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Status do formulário:</span>
              <Badge variant={form.formState.isValid ? 'default' : 'destructive'}>
                {form.formState.isValid ? 'Válido' : 'Inválido'}
              </Badge>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}